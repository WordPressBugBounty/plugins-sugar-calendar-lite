((s,t)=>{var e=window.SugarCalendar||{};e.Admin=e.Admin||{},e.Admin.EventMetabox={init:function(t){this.settings=t,this.$el=s(".sugar-calendar-event-details-metabox"),this.$sectionButtons=s(".sugar-calendar-metabox__navigation__button",this.$el),this.$sections=s(".sugar-calendar-metabox__section",this.$el),this.$startDate=s("#start_date",this.$el),this.$startTimeHour=s("#start_time_hour",this.$el),this.$startTimeMinute=s("#start_time_minute",this.$el),this.$startTimeAmPm=s("#start_time_am_pm",this.$el),this.$startTz=s("#sugar-calendar_start_tz",this.$el),this.$endDate=s("#end_date",this.$el),this.$endTimeHour=s("#end_time_hour",this.$el),this.$endTimeMinute=s("#end_time_minute",this.$el),this.$endTimeAmPm=s("#end_time_am_pm",this.$el),this.$endTz=s("#sugar-calendar_end_tz",this.$el),this.$allDay=s("#all_day",this.$el),this.$timezones=s(".sugar-calendar-metabox__field-row--time-zone, .event-time-zone, .event-time",this.$el),this.$submitButton=s("#publish"),this.$tagsSelect=s(".sugar-calendar-column-tags-form select"),this.bindEvents(),this.initChoicesJS(),this.initDatepickers()},bindEvents:function(){this.$sectionButtons.on("click",this.onSectionButtonClick.bind(this)),this.$allDay.on("change",this.toggleTimezones.bind(this)),this.$submitButton.on("click",this.validateDates.bind(this))},onSectionButtonClick:function(t){var t=s(t.currentTarget),e=t.attr("data-id"),e=this.$sections.filter(`[data-id=${e}]`);this.$sectionButtons.removeClass("selected"),this.$sections.removeClass("selected"),t.addClass("selected"),e.addClass("selected")},initChoicesJS:function(){s(".choicesjs-select",this.$el).each((t,e)=>{new Choices(e,{itemSelectText:"",allowHTML:!0})}),this.initChoicesJSForTags()},initChoicesJSForTags:function(){var t=this.settings.choicesjs_config,e=this.$tagsSelect[0],t=(t.noResultsText=this.settings.strings.add_new_tag,new Choices(e,t)),i=t.getValue(!0);t.clearStore().setChoices(this.settings.all_tags_choices,"value","label",!0).setChoiceByValue(i),s(e).data("choicesjs",t),s(e).siblings("input").on("keydown",this.addCustomTagInput.bind(this))},initDatepickers:function(){s("[data-datepicker]",this.$el).datepicker({dateFormat:"yy-mm-dd",firstDay:this.settings.start_of_week,beforeShow:()=>{s("#ui-datepicker-div").removeClass("ui-datepicker").addClass("sugar-calendar-datepicker")}}),this.$startDate.on("change",()=>{var t=this.getEventDateTime(this.$startDate,this.$startTimeHour,this.$startTimeMinute,this.$startTimeAmPm,this.$startTz),e=this.getEventDateTime(this.$endDate,this.$endTimeHour,this.$endTimeMinute,this.$endTimeAmPm,this.$endTz);""!==this.$endDate.val()&&!e.isBefore(t)||this.$endDate.datepicker("setDate",this.$startDate.val())}),this.$startTimeHour.on("change",()=>this.adjustTime(this.$startTimeHour,this.$endTimeHour,1)),this.$endTimeHour.on("change",()=>this.adjustTime(this.$endTimeHour,this.$startTimeHour,-1)),this.$startTimeMinute.on("change",()=>{""===this.$endTimeMinute.val()&&this.$endTimeMinute.val(this.$startTimeMinute.val())}),this.$startTimeAmPm.on("change",()=>{""===this.$endTimeAmPm.val()&&this.$endTimeAmPm.val(this.$startTimeAmPm.val())}),this.$endDate.on("change",()=>{var t=this.getEventDateTime(this.$startDate,this.$startTimeHour,this.$startTimeMinute,this.$startTimeAmPm,this.$startTz),e=this.getEventDateTime(this.$endDate,this.$endTimeHour,this.$endTimeMinute,this.$endTimeAmPm,this.$endTz);""!==this.$startDate.val()&&!e.isBefore(t)||this.$startDate.datepicker("setDate",this.$endDate.val())}),this.$endTimeMinute.on("change",()=>{""===this.$startTimeMinute.val()&&this.$startTimeMinute.val(this.$endTimeMinute.val())}),this.$endTimeAmPm.on("change",()=>{""===this.$startTimeAmPm.val()&&this.$startTimeAmPm.val(this.$endTimeAmPm.val())}),this.$endDate.datepicker("option","minDate",this.getDate(this.$startDate.val())),"object"==typeof wp.blockEditor&&s.each([this.startDate,this.$startTimeHour,this.$startTimeMinute,this.$startTimeAmPm,this.$endDate,this.$endTimeHour,this.$endTimeMinute,this.$endTimeAmPm],function(t,e){s(e).on("change",this.blockEditorDateValidation.bind(this))}.bind(this))},getDate:function(e){try{e=s.datepicker.parseDate("yy-mm-dd",e)}catch(t){e=null}return e},toggleTimezones:function(){this.$allDay.prop("checked")?this.$timezones.hide():this.$timezones.show()},adjustTime(e,i,s){if(""===i.val()){var a=parseInt(sugar_calendar_admin_event_meta_box.clock_type,10);let t=(parseInt(e.val(),10)+s+a)%a;12===a&&0===t&&(t=12),i.val(t.toString().padStart(2,"0"))}},isStartEndInvalid:function(){var t,e;return("multi"!==this.settings.timezone_type||this.$startTz.val()===this.$endTz.val())&&(t=this.getEventDateTime(this.$startDate,this.$startTimeHour,this.$startTimeMinute,this.$startTimeAmPm,this.$startTz),(e=this.getEventDateTime(this.$endDate,this.$endTimeHour,this.$endTimeMinute,this.$endTimeAmPm,0<this.$endTz.length?this.$endTz:this.$startTz)).isBefore(t)||e.isSame(t))},validateDates:function(t){!1===this.$allDay.prop("checked")&&this.isStartEndInvalid()&&(t.preventDefault(),this.$sectionButtons.filter("[data-id=duration]").click(),this.$sections.filter("[data-id=duration]").addClass("sugar-calendar-field-dates-invalid"))},getEventDateTime:function(t,e,i,s,a){var n=sugar_calendar_admin_event_meta_box.clock_type,h=moment().format("YYYY-MM-DD"),t=t&&t.val()||h,h=e&&e.val()||"01",e=i&&i.val()||"00",i="12"===n&&s?s.val()||"AM":"",s=a&&a.val()||"";return this.createMomentObject(t,h,e,i,n,s)},createMomentObject(t,e,i,s,a,n){let h=parseInt(e,10),r=parseInt(i,10);"12"===a&&s&&("pm"===(e=s.toLowerCase())&&12!==h?h+=12:"am"===e&&12===h&&(h=0)),"24"===a&&(h=Math.min(Math.max(h,0),23)),r=Math.min(Math.max(r,0),59);i=`${t} ${h.toString().padStart(2,"0")}:`+r.toString().padStart(2,"0");return moment.tz(i,"YYYY-MM-DD HH:mm",n)},blockEditorDateValidation:function(){var t,e,i;""!==this.$startDate.val()&&""!==this.$startTimeHour.val()&&""!==this.$endDate.val()&&""!==this.$endTimeHour.val()&&(t=this.getEventDateTime(this.$startDate,this.$startTimeHour,this.$startTimeMinute,this.$startTimeAmPm,this.$startTz),e=this.getEventDateTime(this.$endDate,this.$endTimeHour,this.$endTimeMinute,this.$endTimeAmPm,this.$endTz),i="invalid-date-error",this.isStartEndInvalid()?(wp.data.dispatch("core/editor").lockPostSaving(i),wp.data.dispatch("core/notices").createNotice("error",wp.i18n.__("End date and time cannot be before the start date and time.","sugar-calendar-lite"),{id:i,isDismissible:!0})):e.isAfter(t)&&(wp.data.dispatch("core/editor").unlockPostSaving(i),wp.data.dispatch("core/notices").removeNotice(i)))},addCustomTagInput:function(t){var e,i;["Enter",","].indexOf(t.key)<0||(t.preventDefault(),t.stopPropagation(),(e=s(t.target).closest(".choices").find("select").data("choicesjs"))&&0!==t.target.value.length&&(""===(t=_.escape(t.target.value.trim()))||0<=_.map(e.getValue(),"label").map(t=>t.toLowerCase().trim()).indexOf(t.toLowerCase())||((i=_.find(this.settings.all_tags_choices||[],{label:t}))&&i.value?e.setChoiceByValue(i.value):e.setChoices([{value:t,label:t,selected:!0}],"value","label",!1)),e.clearInput()))}},e.Admin.EventMetabox.init(t),window.SugarCalendar=e})(jQuery,sugar_calendar_admin_event_meta_box);