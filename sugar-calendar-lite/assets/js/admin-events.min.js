((r,s,t)=>{let a=window.SugarCalendar||{};a.Admin=a.Admin||{},a.Admin.Events={init:function(t){this.settings=t,this.$calendarDropdown=r("#sc_event_category"),this.$screenOptionsToggle=r("#sugar-calendar-screen-options-toggle"),this.$screenOptionsMenu=r(".sugar-calendar-screen-options-menu"),this.$columnFields=r('[name="sugar-calendar[columns][]"]',this.$screenOptionsMenu),this.$gridColumnLayout=r("#sugar-calendar-table-grid-column-layout"),this.$tableEventsList=r(".sugar-calendar-table-events--list"),this.$listTableRows=r(".sugar-calendar-table-events--list #the-list"),this.$tagsFilterSelect=r("#sugar-calendar-tags-filter"),this.$tagsFilterButton=r("#sugar-calendar-tags-filter-button"),this.$bulkEditTagsRow=r(".sugar-calendar-bulk-edit-tags-row"),this.$bulkActionSelector=r("#bulk-action-selector-top"),this.$tableNavActionButton1=r(".sugar-calendar-tablenav #doaction"),this.$tableNavActionButton2=r(".sugar-calendar-tablenav #doaction2"),this.$bulkEditTagsEventsWrapper=r(".sugar-calendar-bulk-edit-tags-field-wrapper--events"),this.$bulkEditTagsEvents=r("#sugar-calendar-bulk-edit-tags-events"),this.$bulkEditTagsTerms=r("#sugar-calendar-bulk-edit-tags-terms"),this.$bulkEditTagsSave=r(".sugar-calendar-bulk-edit-tags-save"),this.$bulkEditTagsCancel=r(".sugar-calendar-bulk-edit-tags-cancel"),this.$bulkEditTagsMessage=r(".sugar-calendar-bulk-edit-tags-message"),this.currentTagsBackup=null,this.currentTagsChoicesObj=null,this.bulkEditIsOpen=!1,this.bindEvents(),this.initializeTooltips(),this.initializeTagsTool(),this.initializeTagsFilter(),this.initializeChoicesEventHandlers()},bindEvents:function(){this.$calendarDropdown.on("change",t=>r(t.target).parents("form").submit()),this.$screenOptionsToggle.on("click",this.onScreenOptionsToggleClick.bind(this)),this.$columnFields.on("click",this.onColumnsChange.bind(this)),this.$bulkEditTagsCancel.on("click",this.cancelBulkEditTagsClick.bind(this))},onScreenOptionsToggleClick:function(t){this.$screenOptionsToggle.toggleClass("open"),this.$screenOptionsMenu.fadeToggle(200)},onColumnsChange:function(t){this.updateColumnsChange(this.getAllColumns())},getAllColumns:function(){let s=this;return this.$columnFields.map(function(){var t=r(this);let e=t.is(":checked");return("title"===t.val()||"tags"===t.val()&&s.bulkEditIsOpen)&&(e=!0),{id:t.val(),visible:e}}).toArray()},updateColumnsChange:function(t){this.hideColumns(t),this.hideEventSpans(t),this.updateGridColumnLayout(t),this.updateHiddenColumns(t),this.adjustBulkEditTagsColspans(t)},hideColumns:function(t){t=t.filter(t=>!t.visible).map(t=>".column-"+t.id).join(",");r(".column, th, td",".sugar-calendar-table").removeClass("hidden"),r(t,".sugar-calendar-table").addClass("hidden")},hideEventSpans:function(t){let e=t.filter(t=>!t.visible).map(t=>t.id);r(".event-span",".sugar-calendar-table-events").removeClass("hidden"),r(".event-span",".sugar-calendar-table-events").each(function(){var t=r(this);0===t.attr("data-days").split(",").filter(t=>!e.includes(t)).length&&t.addClass("hidden")})},updateGridColumnLayout:function(s){var t=s.map(t=>{var e=t.id===s[0].id?"120px":"1fr";return`[${t.id}] `+(t.visible?`minmax(0, ${e})`:"0fr")}).join(" ");this.$gridColumnLayout.html(`
				.sugar-calendar-table-events {
					--grid-template-columns: ${t};
				}
			`)},updateHiddenColumns:function(t){t=t.filter(t=>!t.visible).map(t=>t.id);r.post(this.settings.ajax_url,{columns:t,mode:r("[name=mode]",this.$screenOptionsMenu).val(),cd:r("[name=cd]",this.$screenOptionsMenu).val(),cm:r("[name=cm]",this.$screenOptionsMenu).val(),cy:r("[name=cy]",this.$screenOptionsMenu).val(),task:"update_hidden_columns"})},initializeTooltips:function(){var t=r(".sugar-calendar-event-entry"),e=r(".sugar-calendar-event-entry span");t.on("click",t=>t.preventDefault()),e.each(function(){s(r(this).get(0),{trigger:"click",allowHTML:!0,interactive:!0,triggerTarget:r(this).parent("a").get(0),offset:[0,12],content(t){t=t.parentElement.getAttribute("data-id");return r("#sugar-calendar-tooltip-"+t).html()}})})},initializeTagsTool:function(){r(this.$tableEventsList).on("click",".sugar-calendar-column-tags-edit-link",this.editTagsClick.bind(this)).on("click",".sugar-calendar-column-tags-edit-cancel",this.cancelEditTagsClick.bind(this)).on("click",".sugar-calendar-column-tags-edit-save",this.saveTagsClick.bind(this)).on("click",".sugar-calendar-column-tags-form .choices .choices__arrow",this.closeChoices.bind(this)).on("keydown",".sugar-calendar-column-tags-form input",this.addCustomTagInput.bind(this)),r(this.$tableNavActionButton1).on("click",this.confirmBulkAction.bind(this)),r(this.$tableNavActionButton2).on("click",this.confirmBulkAction.bind(this)),r(this.$bulkEditTagsEvents).on("removeItem",this.bulkEditTagsFormRemoveItem.bind(this)),r(this.$bulkEditTagsSave).on("click",this.saveBulkEditTagsClick.bind(this))},confirmBulkAction:function(t){"edit_tags"===this.$bulkActionSelector.val()&&(t.preventDefault(),this.openBulkEditTags())},openBulkEditTags:function(){let n=[],l=[],c=[];var t;this.$listTableRows.find("input:checked").each(function(){let t=r(this),e=t.closest("tr"),s=e.find(".column-title > strong a:first-child span"),a=e.find(".sugar-calendar-column-tags-links"),i=a.data("tags").toString()||"";n.push({value:t.val(),label:_.escape(s.text())}),l.push(t.val()),i=i.length?i.split(","):[],c=_.union(c,i)}),0!==n.length&&((t=this.getAllColumns()).forEach(t=>{"tags"===t.id&&(t.visible=!0)}),this.updateColumnsChange(t),this.$bulkEditTagsRow.removeClass("sugar-calendar-hidden"),this.bulkEditIsOpen=!0,this.initChoicesJS(this.$bulkEditTagsEvents).clearStore().setChoices(n,"value","label",!0).setChoiceByValue(l),this.initChoicesJS(this.$bulkEditTagsTerms).removeActiveItems().setChoiceByValue(c),this.updateBulkEditTagsFormMessage(l))},adjustBulkEditTagsColspans:function(t){var e=this.$bulkEditTagsEvents.parents("td"),s=this.$bulkEditTagsTerms.parents("td"),a=this.$bulkEditTagsSave.parents("td"),i=this.$bulkEditTagsMessage.parents("td");let n=2,l=1;t.forEach(t=>{("start"===t.id&&t.visible||"end"===t.id&&t.visible)&&(n+=1),("duration"===t.id&&t.visible||"repeat"===t.id&&t.visible)&&(l+=1)}),e.attr("colspan",n),s.attr("colspan",l),a.attr("colspan",n+l),i.attr("colspan",n+l)},updateBulkEditTagsFormMessage:function(t){var e=this.settings.strings.bulk_edit_n_events;1===t.length&&(e=this.settings.strings.bulk_edit_one_event),this.$bulkEditTagsMessage.html(e.replace("%d",t.length))},bulkEditTagsFormRemoveItem:function(t){var e=r(t.target).data("choicesjs").getValue(!0);0===e.length&&this.cancelBulkEditTagsClick(t),this.updateBulkEditTagsFormMessage(e)},cancelBulkEditTagsClick:function(t){t.preventDefault(),this.bulkEditIsOpen=!1,this.$bulkEditTagsRow.addClass("sugar-calendar-hidden")},initChoicesJS:function(t){if(!this.settings.choicesjs_config||!t.length||"function"!=typeof window.Choices)return!1;var e=this.settings.choicesjs_config;"sugar-calendar-tags-filter"===t.attr("id")?e.noResultsText=this.settings.strings.no_results_text:e.noResultsText=this.settings.strings.add_new_tag,e.callbackOnInit=function(){t.closest(".choices__inner").append('<div class="choices__arrow"></div>'),a.Admin.Events.showMoreButtonForChoices(this.containerOuter.element)};let s;e=(s="active"===t.data("choice")?t.data("choicesjs"):new Choices(t[0],e)).getValue(!0);return s.clearStore().setChoices(this.settings.all_tags_choices||[],"value","label",!0).setChoiceByValue(e),t.data("choicesjs",s),s},closeChoices:function(t){t.preventDefault(),this.currentTagsChoicesObj&&this.currentTagsChoicesObj.dropdown.isActive&&this.currentTagsChoicesObj.hideDropdown()},editTagsClick:function(t){t.preventDefault();var t=r(t.target).closest("td"),e=t.closest("tbody"),s=t.find(".sugar-calendar-column-tags-links"),t=t.find(".sugar-calendar-column-tags-form"),a=t.find("select");e.find(".sugar-calendar-column-tags-links.sugar-calendar-hidden").not(".sugar-calendar-bulk-edit-tags-row *").removeClass("sugar-calendar-hidden"),e.find(".sugar-calendar-column-tags-form:not(.sugar-calendar-hidden)").not(".sugar-calendar-bulk-edit-tags-row *").addClass("sugar-calendar-hidden"),s.addClass("sugar-calendar-hidden"),t.removeClass("sugar-calendar-hidden"),this.currentTagsChoicesObj=this.initChoicesJS(a),this.currentTagsBackup=this.currentTagsChoicesObj.getValue(!0)},cancelEditTagsClick:function(t){t.preventDefault();var t=r(t.target).closest("td"),e=t.find(".sugar-calendar-column-tags-links"),t=t.find(".sugar-calendar-column-tags-form");this.currentTagsChoicesObj.removeActiveItems().setChoiceByValue(this.currentTagsBackup),e.removeClass("sugar-calendar-hidden"),t.addClass("sugar-calendar-hidden")},getTagsValue:function(t){if(!t||"function"!=typeof t.getValue)return[];var e=t.getValue(),s=[];for(let t=0;t<e.length;t++)s.push({value:e[t].value,label:e[t].label});return s},saveTagsClick:function(t){t.preventDefault();let e=r(t.target),s=e.closest("td"),a=s.find(".sugar-calendar-column-tags-links"),i=s.find(".sugar-calendar-column-tags-form"),n=i.find(".sugar-calendar-spinner"),l=a.data("event-id");e.addClass("sugar-calendar-hidden"),n.removeClass("sugar-calendar-hidden"),this.saveTagsAjax({events:[l],tags:this.getTagsValue(this.currentTagsChoicesObj)},t=>{var e;t.success?(a.find(".sugar-calendar-column-tags-links-list").html(t.data.tags_links),a.data("tags",t.data.tags_ids),t.data.all_tags_choices&&(this.settings.all_tags_choices=t.data.all_tags_choices),(e=i.find("select")).html(t.data.tags_options),(e=e.data("choicesjs"))&&(e.clearStore().setChoices(this.settings.all_tags_choices||[],"value","label",!0),t.data.tags_ids)&&e.setChoiceByValue(t.data.tags_ids.split(","))):alert(t.data||this.settings.strings.error)},()=>{e.removeClass("sugar-calendar-hidden"),n.addClass("sugar-calendar-hidden"),a.removeClass("sugar-calendar-hidden"),i.addClass("sugar-calendar-hidden")})},saveBulkEditTagsClick:function(t){t.preventDefault();let n=this,e=r(t.target),s=e.find(".sugar-calendar-spinner"),l={events:this.$bulkEditTagsEvents.data("choicesjs").getValue(!0),tags:this.getTagsValue(this.$bulkEditTagsTerms.data("choicesjs"))};s.removeClass("sugar-calendar-hidden"),this.saveTagsAjax(l,i=>{r("#the-list .tags.column-tags").each(function(){var t=r(this),e=t.find(".sugar-calendar-column-tags-links"),s=e.data("event-id")+"",t=t.find(".sugar-calendar-column-tags-form select"),a=t.data("choicesjs");l.events.indexOf(s)<0||(e.data("tags",i.data.tags_ids),e.find(".sugar-calendar-column-tags-links-list").html(i.data.tags_links),t.html(i.data.tags_options),a&&a.clearStore().setChoices(n.settings.all_tags_choices||[],"value","label",!0).setChoiceByValue(i.data.tags_ids.split(",")))})},()=>{s.addClass("sugar-calendar-hidden"),this.$bulkEditTagsRow.addClass("sugar-calendar-hidden")})},saveTagsAjax:function(t,e,s){let a=this;r.post(a.settings.ajax_url,r.extend({action:"sugar_calendar_save_event_tags",nonce:a.settings.strings.nonce},t)).done(function(t){t.success&&t.data?(a.updateAllTagsChoices(t.data.all_tags_choices),"function"==typeof e&&e(t)):alert(t.data||a.settings.strings.error)}).fail(function(t,e,s){alert(a.settings.strings.error)}).always(function(){"function"==typeof s&&s()})},updateAllTagsChoices:function(t){t&&(this.settings.all_tags_choices=t,this.initChoicesJS(this.$tagsFilterSelect))},addCustomTagInput:function(t){var e,s;["Enter",","].indexOf(t.key)<0||(t.preventDefault(),t.stopPropagation(),(e=r(t.target).closest(".choices").find("select").data("choicesjs"))&&0!==t.target.value.length&&(""===(t=_.escape(t.target.value.trim()))||0<=_.map(e.getValue(),"label").map(t=>t.toLowerCase().trim()).indexOf(t.toLowerCase())||((s=_.find(this.settings.all_tags_choices||[],{label:t}))&&s.value?e.setChoiceByValue(s.value):e.setChoices([{value:t,label:t,selected:!0}],"value","label",!1)),e.clearInput()))},showMoreButtonForChoices(t){var e,s;"select-one"!==r(t).data("type")&&(e=r(t).find(".choices__list--multiple .choices__item").first(),s=r(t).find(".choices__list--multiple .choices__item").last(),r(t).removeClass("choices__show-more"),0<e.length)&&0<s.length&&e.position().top!==s.position().top&&r(t).addClass("choices__show-more")},initializeChoicesEventHandlers(){r(document).on("addItem removeItem",".choices:not(.is-disabled)",function(){a.Admin.Events.showMoreButtonForChoices(this)}),r(document).on("hideDropdown",".choices:not(.is-disabled)",function(){r(this).find(".choices__inner input.choices__input").trigger("blur")})},initializeTagsFilter:function(){this.$tagsFilterSelect.length&&this.initChoicesJS(this.$tagsFilterSelect)&&this.$tagsFilterButton.on("click",function(){var t=r("#sugar-calendar-tags-filter").val(),e=window.location.href;let s;s=t?a.Admin.Events.addQueryArg("sc_event_tags",t,e):a.Admin.Events.removeQueryArg("sc_event_tags",e),window.location.href=s})},addQueryArg:function(t,e,s){var a=new RegExp("([?&])"+t+"=.*?(&|$)","i"),i=-1!==s.indexOf("?")?"&":"?";return s.match(a)?s.replace(a,"$1"+t+"="+e+"$2"):s+i+t+"="+e},removeQueryArg:function(t,e){var s=e.split("?");if(2<=s.length){var a=encodeURIComponent(t)+"=",i=s[1].split(/[&;]/g);for(let t=i.length;0<t--;)-1!==i[t].lastIndexOf(a,0)&&i.splice(t,1);e=s[0]+(0<i.length?"?"+i.join("&"):"")}return e}},a.Admin.Events.init(t),window.SugarCalendar=a})(jQuery,tippy,sugar_calendar_admin_events);