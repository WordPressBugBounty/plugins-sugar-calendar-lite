"use strict";var sugar_calendar=window.sugar_calendar||function(r,s){function d(a){a.find(".sugar-calendar-block__popover").removeClass("sugar-calendar-block__controls__settings__btn_active").hide(),a.find(".sugar-calendar-block__controls__settings__btn").removeClass("sugar-calendar-block__controls__settings__btn_active"),a.find(".sugar-calendar-block__controls__left__date").removeClass("sugar-calendar-block__controls__settings__btn_active"),s("body").removeClass("sugar-calendar-block__popovers__active")}Array.prototype.uniquePush=function(a){return this.includes(a)||this.push(a),this};function e(a,e){this.$popover=a,this.$mainContainer=e}function t(n){this.$mainContainer=n;let t=[{key:"month_selector",popover_selector:".sugar-calendar-block__popover__month_selector",button_selector:".sugar-calendar-block__controls__left__date"},{key:"calendar_selector",popover_selector:".sugar-calendar-block__popover__calendar_selector",button_selector:".sugar-calendar-block__controls__right__settings__btn"},{key:"display_selector",popover_selector:".sugar-calendar-block__popover__display_selector",button_selector:".sugar-calendar-block__controls__right__view__btn"}],o=this;t.forEach(a=>{var e=n.find(a.button_selector);e.on("click",o.toggle.bind(o,e,a.key,t))})}function a(a){this.calendarBlock=a}function n(a){this.$mainContainer=a,this.$formContainer=a.find(".sugar-calendar-block-settings"),this.$mobileListContainer=a.find(".sugar-calendar-block__mobile_event_list"),this.id=this.$formContainer.find('input[name="sc_calendar_id"]').val(),this.$searchContainer=a.find(".sugar-calendar-block__controls__right__search__field"),this.$searchClear=a.find(".sugar-calendar-block__controls__right__search__clear"),this.$timeOfDayContainer=a.find(".sugar-calendar-block__popover__calendar_selector__container__time"),this.$daysOfWeekContainer=a.find(".sugar-calendar-block__popover__calendar_selector__container__days"),this.$datePicker=a.find(".sugar-calendar-block__controls__datepicker"),void 0!==this.id&&0<this.id.length&&(this.initPopovers(),this.initControls(),this.initDatePicker()),1===parseInt(this.$formContainer.find('input[name="sc_visitor_tz_convert"]').val())&&this.update()}let h=null,o=(e.prototype.show=function(a){var e=s(a.target);let n;e=(n=e.hasClass("sugar-calendar-block__event-cell")?e:s(a.target).parents(".sugar-calendar-block__event-cell")).data("eventobjid");let t=this.$popover.find(".sugar-calendar-block__popover__event__container__image"),o=this.$popover.find(".sugar-calendar-block__popover__event__container__content__description");t.hide(),t.css("background-image",""),o.text(""),void 0!==e&&(o.prepend('<div class="sugar-calendar-block__loading sugar-calendar-block__loading--no-overlay"></div>'),s.post(sugar_calendar_obj.ajax_url,{action:"sugar_calendar_event_popover",event_object_id:e,nonce:sugar_calendar_obj.nonce},function(a){if(a.success&&a.data){a.data.image&&(t.css("background-image",`url(${a.data.image})`),t.show());let n=[];a.data.description&&(a=s.parseHTML(a.data.description.trim()),s.each(a,function(a,e){n.push(e.textContent)})),o.html(""),o.text(n.join(""))}}));var a=n.find(".sugar-calendar-block__event-cell__title").text().trim(),e=n.find(".sugar-calendar-block__event-cell__time").text().trim(),r=this.$popover.find(".sugar-calendar-block__popover__event__container__content__title__link");r.attr("href",n.data("eventurl")),r.text(a);let i=Intl.DateTimeFormat().resolvedOptions().timeZone,l="",_=n.data("daydate");"undefined"!=typeof SCTimeZones&&i.length?(l=wp.date.dateI18n(SCTimezoneConvert.date_format,_.start_date.datetime,i),_.end_date&&(l+=" - "+wp.date.dateI18n(SCTimezoneConvert.date_format,_.end_date.datetime,i))):(l=_.start_date.value,_.end_date&&(l+=" - "+_.end_date.value)),this.$popover.find(".sugar-calendar-block__popover__event__container__content__date").text(l),this.$popover.find(".sugar-calendar-block__popover__event__container__content__time").text(e);r=this.$popover.find(".sugar-calendar-block__popover__event__container__content__calendar");r.html("");let c=n.data("calendarsinfo");if(void 0!==c&&void 0!==c.calendars){let e=[];c.calendars.forEach(a=>{e.push(`<div style="border-left: 2px solid ${a.color||c.primary_event_color};" class="sugar-calendar-block__popover__event__container__content__calendar__item">${a.name}</div>`)}),r.html(e.join(""))}h.computePosition(n[0],this.$popover[0],{placement:"bottom-start",middleware:[h.offset(10),h.flip(),h.shift()]}).then(({x:a,y:e})=>{Object.assign(this.$popover[0].style,{left:a+"px",top:e+"px"})}),d(this.$mainContainer),this.$popover.show(),s("body").addClass("sugar-calendar-block__popovers__active")},t.prototype.toggle=function(a,e,n){n=n.find(a=>a.key===e),n=this.$mainContainer.find(n.popover_selector);n.is(":visible")?d(this.$mainContainer):(d(this.$mainContainer),this.show(a,n,e))},t.prototype.show=function(a,n,e){var t=r.innerWidth<768,o=[h.offset(10),h.shift()];t?a[0].scrollIntoView({behavior:"smooth"}):o.push(h.flip()),h.computePosition(a[0],n[0],{placement:"calendar_selector"===e?"bottom-end":"bottom-start",middleware:o}).then(({x:a,y:e})=>{Object.assign(n[0].style,{left:a+"px",top:e+"px"})}),a.addClass("sugar-calendar-block__controls__settings__btn_active"),n.show(),s("body").addClass("sugar-calendar-block__popovers__active")},a.prototype.onSearch=function(a){13===a.keyCode?this.calendarBlock.update():0<a.target.value.length?this.calendarBlock.$searchClear.show():this.calendarBlock.$searchClear.hide()},a.prototype.onSearchClick=function(a){this.calendarBlock.update()},a.prototype.onClearSearch=function(a){this.calendarBlock.$searchContainer.val(""),this.calendarBlock.$searchClear.hide(),this.calendarBlock.update()},a.prototype.goToMonth=function(a){this.calendarBlock.$formContainer.find('input[name="sc_month"]').val(parseInt(a.target.dataset.month)),this.calendarBlock.update()},a.prototype.goToPrevious=function(){switch(this.calendarBlock.getDisplay()){case"day":this.calendarBlock.update(!1,"previous_day");break;case"week":this.calendarBlock.update(!1,"previous_week");break;case"month":this.calendarBlock.update(!1,"previous_month")}},a.prototype.goToNext=function(){switch(this.calendarBlock.getDisplay()){case"day":this.calendarBlock.update(!1,"next_day");break;case"week":this.calendarBlock.update(!1,"next_week");break;case"month":this.calendarBlock.update(!1,"next_month")}},a.prototype.onSelectCalendar=function(){this.calendarBlock.update()},a.prototype.onSelectCurrent=function(){this.calendarBlock.$formContainer.find('input[name="sc_month"]').val(this.calendarBlock.$mainContainer.data("ogmonth")),this.calendarBlock.$formContainer.find('input[name="sc_year"]').val(this.calendarBlock.$mainContainer.data("ogyear")),this.calendarBlock.$formContainer.find('input[name="sc_day"]').val(this.calendarBlock.$mainContainer.data("ogday")),this.calendarBlock.update()},a.prototype.onChangeDisplay=function(a){var a=s(a.target).text().trim(),e=a.toLowerCase();e!==this.calendarBlock.getDisplay()&&(this.calendarBlock.$mainContainer.removeClass(`sugar-calendar-block__${this.calendarBlock.getDisplay()}-view`),this.calendarBlock.$mainContainer.addClass(`sugar-calendar-block__${e}-view`),this.calendarBlock.$formContainer.find('input[name="sc_display"]').val(e),this.calendarBlock.update(!0),this.calendarBlock.$mainContainer.find(".sugar-calendar-block__controls__right__view__btn span").text(a))},n.prototype.initDatePicker=function(){void 0!==this.$datePicker&&this.$datePicker.datepicker("destroy");let a=0,e=("month"===this.getDisplay()&&(a=1),this.$datePicker.datepicker({minViewMode:a,maxViewMode:2,templates:{leftArrow:'<svg width="6" height="11" viewBox="0 0 6 11" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M5.41406 10.6094C5.29688 10.7266 5.13281 10.7266 5.01562 10.6094L0.09375 5.71094C0 5.59375 0 5.42969 0.09375 5.3125L5.01562 0.414062C5.13281 0.296875 5.29688 0.296875 5.41406 0.414062L5.88281 0.859375C5.97656 0.976562 5.97656 1.16406 5.88281 1.25781L1.64062 5.5L5.88281 9.76562C5.97656 9.85938 5.97656 10.0469 5.88281 10.1641L5.41406 10.6094Z" fill="currentColor"/></svg>',rightArrow:'<svg width="6" height="11" viewBox="0 0 6 11" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M0.5625 0.414062C0.679688 0.296875 0.84375 0.296875 0.960938 0.414062L5.88281 5.3125C5.97656 5.42969 5.97656 5.59375 5.88281 5.71094L0.960938 10.6094C0.84375 10.7266 0.679688 10.7266 0.5625 10.6094L0.09375 10.1641C0 10.0469 0 9.85938 0.09375 9.76562L4.33594 5.5L0.09375 1.25781C0 1.16406 0 0.976562 0.09375 0.859375L0.5625 0.414062Z" fill="currentColor"/></svg>'},weekStart:sugar_calendar_obj.settings.sow}),this.$formContainer.find('input[name="sc_year"]')),n=this.$formContainer.find('input[name="sc_month"]'),t=this.$formContainer.find('input[name="sc_day"]');this.$datePicker.datepicker("update",new Date(e.val(),n.val()-1,t.val())),this.$datePicker.on("changeDate",a=>{e.val(a.date.getFullYear()),n.val(a.date.getMonth()+1),"month"!==this.getDisplay()&&t.val(a.date.getDate()),this.update()})},n.prototype.initPopovers=function(){let n=this.$mainContainer;new t(n);var a=n.find(".sugar-calendar-block__popover__event"),a=new e(a,n);768<=r.innerWidth?n.on("click",".sugar-calendar-block__event-cell",a.show.bind(a)):n.on("click",".sugar-calendar-block__calendar-week__header__cell",function(a){let e=s(a.target);(e=e.hasClass("sugar-calendar-block__calendar-week__header__cell")?e:e.parents(".sugar-calendar-block__calendar-week__header__cell")).hasClass("sugar-calendar-block__calendar-week__header__cell--active")||void 0===e.data("weekdaynum")||(n.find(".sugar-calendar-block__calendar-week__header__cell--active").removeClass("sugar-calendar-block__calendar-week__header__cell--active"),n.find(".sugar-calendar-block__calendar-week__time-grid__day-col--active").removeClass("sugar-calendar-block__calendar-week__time-grid__day-col--active"),n.find(".sugar-calendar-block__calendar-week__event-slot--all-day--active").removeClass("sugar-calendar-block__calendar-week__event-slot--all-day--active"),e.addClass("sugar-calendar-block__calendar-week__header__cell--active"),n.find(".sugar-calendar-block__calendar-week__event-slot--all-day--"+e.data("weekdaynum")).addClass("sugar-calendar-block__calendar-week__event-slot--all-day--active"),n.find(".sugar-calendar-block__calendar-week__time-grid__day-col-"+e.data("weekdaynum")).addClass("sugar-calendar-block__calendar-week__time-grid__day-col--active"))})},n.prototype.initControls=function(){this.controlEvents=new a(this),this.$searchContainer.on("keyup",this.controlEvents.onSearch.bind(this.controlEvents)),this.$searchClear.on("click",this.controlEvents.onClearSearch.bind(this.controlEvents)),this.$mainContainer.find(".sugar-calendar-block__controls__right__search__icon").on("click",this.controlEvents.onSearchClick.bind(this.controlEvents)),this.$mainContainer.find(".sugar-calendar-block__popover__month_selector__container__body__month").on("click",this.controlEvents.goToMonth.bind(this.controlEvents)),this.$mainContainer.find(".sugar-calendar-block__controls__left__pagination__prev").on("click",this.controlEvents.goToPrevious.bind(this.controlEvents)),this.$mainContainer.find(".sugar-calendar-block__controls__left__pagination__next").on("click",this.controlEvents.goToNext.bind(this.controlEvents)),this.$mainContainer.find(".sugar-calendar-block__controls__left__pagination__current").on("click",this.controlEvents.onSelectCurrent.bind(this.controlEvents)),this.$mainContainer.find(".sugar-calendar-block__popover__calendar_selector__container__options__val__cal").on("change",this.controlEvents.onSelectCalendar.bind(this.controlEvents)),this.$mainContainer.find(".sugar-calendar-block__popover__calendar_selector__container__options__val__day").on("change",this.displayEvents.bind(this)),this.$mainContainer.find(".sugar-calendar-block__popover__calendar_selector__container__options__val__time").on("change",this.displayEvents.bind(this)),this.$mainContainer.find(".sugar-calendar-block__popover__display_selector__container__body__option").on("click",this.controlEvents.onChangeDisplay.bind(this.controlEvents)),r.innerWidth<768&&(this.$mainContainer.on("click",".sugar-calendar-block__calendar-month__body__day",this.showMobileEvents.bind(this)),this.$mainContainer.on("click",".sugar-calendar-block__mobile_event_list .sugar-calendar-block__event-cell",this.onMobileEventCellClicked.bind(this)),this.$mainContainer.on("click",".sugar-calendar-block__calendar-week__event-slot .sugar-calendar-block__event-cell",this.onMobileEventCellClicked.bind(this)),this.$mainContainer.on("click",".sugar-calendar-block__calendar-day .sugar-calendar-block__event-cell",this.onMobileEventCellClicked.bind(this)))},n.prototype.onMobileEventCellClicked=function(a){let e=s(a.target);(e=e.hasClass("sugar-calendar-block__event-cell")?e:e.parents(".sugar-calendar-block__event-cell")).data("eventurl")&&(r.location.href=e.data("eventurl"))},n.prototype.getCalendarIds=function(){let a=[];return this.$mainContainer.find(".sugar-calendar-block__popover__calendar_selector__container__options__val__cal:checked").each(function(){a.push(s(this).val())}),a},n.prototype.getCalendarsFilter=function(){var a=this.$formContainer.find('input[name="sc_calendars_filter"]');return a.length<=0||(a=a.val()).length<=0?[]:a.split(",")},n.prototype.getDisplay=function(){return this.$formContainer.find('input[name="sc_display"]').val()},n.prototype.update=function(a=!1,e=""){d(this.$mainContainer);let n=this.$mainContainer.find(".sugar-calendar-block__base-container"),t=(n.addClass("sugar-calendar-block__loading-state"),n.prepend('<div class="sugar-calendar-block__base-container__overlay"><div class="sugar-calendar-block__loading"></div></div>'),this);a={id:this.id,calendars:this.getCalendarIds(),calendarsFilter:this.getCalendarsFilter(),day:parseInt(this.$formContainer.find('input[name="sc_day"]').val()),month:parseInt(this.$formContainer.find('input[name="sc_month"]').val()),year:parseInt(this.$formContainer.find('input[name="sc_year"]').val()),search:this.$searchContainer.val(),accentColor:this.$mainContainer.data("accentcolor")?this.$mainContainer.data("accentcolor"):"",display:this.getDisplay(),visitor_tz_convert:parseInt(this.$formContainer.find('input[name="sc_visitor_tz_convert"]').val()),visitor_tz:Intl.DateTimeFormat().resolvedOptions().timeZone,updateDisplay:a,action:e};s.post(sugar_calendar_obj.ajax_url,{action:"sugar_calendar_block_update",calendar_block:a,nonce:sugar_calendar_obj.nonce},function(e){if(e.success){t.$formContainer.find('input[name="sc_day"]').val(e.data.date.day),t.$formContainer.find('input[name="sc_month"]').val(e.data.date.month),t.$formContainer.find('input[name="sc_year"]').val(e.data.date.year);let a="";switch(t.getDisplay()){case"day":t.$mainContainer.find(".sugar-calendar-block__view-heading").text(e.data.heading),t.$mainContainer.find(".sugar-calendar-block__view-heading-mobile").text(e.data.heading_mobile),t.$mainContainer.find(".sugar-calendar-block__view-heading--year").hide(),e.data.is_update_display&&(t.$mainContainer.find(".sugar-calendar-block__popover__calendar_selector__container__days").hide(),a=sugar_calendar_obj.strings.today);break;case"week":t.$mainContainer.find(".sugar-calendar-block__view-heading").text(e.data.heading),t.$mainContainer.find(".sugar-calendar-block__view-heading-mobile").text(e.data.heading_mobile),t.$mainContainer.find(".sugar-calendar-block__view-heading--year").hide(),e.data.is_update_display&&(t.$mainContainer.find(".sugar-calendar-block__popover__calendar_selector__container__days").show(),t.$mobileListContainer.hide(),a=sugar_calendar_obj.strings.this_week);break;default:t.$mainContainer.find(".sugar-calendar-block__view-heading").text(e.data.heading),t.$mainContainer.find(".sugar-calendar-block__view-heading-mobile").text(e.data.heading_mobile),t.$mainContainer.find(".sugar-calendar-block__view-heading--year").text(e.data.date.year),t.$mainContainer.find(".sugar-calendar-block__view-heading--year").show(),e.data.is_update_display?(t.$mainContainer.find(".sugar-calendar-block__popover__calendar_selector__container__days").show(),t.$mobileListContainer.show(),a=sugar_calendar_obj.strings.this_month):(t.$mainContainer.find(".sugar-calendar-block__base-container__overlay").remove(),n.removeClass("sugar-calendar-block__loading-state"),n=t.$mainContainer.find(".sugar-calendar-block__calendar-month__body"))}""!==a&&t.$mainContainer.find(".sugar-calendar-block__controls__left__pagination__current").text(a),n.html(e.data.body),n.removeClass("sugar-calendar-block__loading-state"),t.displayEvents(),e.data.is_update_display?t.initDatePicker():t.$datePicker.datepicker("update",new Date(e.data.date.year,e.data.date.month-1,e.data.date.day)),"undefined"!=typeof SCTimeZones&&SCTimeZones.convertEventsTime()}})},n.prototype.getTimeOfDay=function(){return this.$timeOfDayContainer.find(".sugar-calendar-block__popover__calendar_selector__container__options__val__time:checked").map((a,e)=>e.value).get()},n.prototype.getDaysOfWeek=function(){return this.$daysOfWeekContainer.find(".sugar-calendar-block__popover__calendar_selector__container__options__val__day:checked").map((a,e)=>e.value).get()},n.prototype.showMobileEvents=function(a){var e=this.$mobileListContainer.find(".sugar-calendar-block__mobile_event_list__date"),n=this.$mobileListContainer.find(".sugar-calendar-block__mobile_event_list__events_container"),t=(e.html(""),n.html(""),s(a.target));let o;t=(o=t.hasClass("sugar-calendar-block__calendar-month__body__day")?t:s(a.target).parents(".sugar-calendar-block__calendar-month__body__day")).find(".sugar-calendar-block__calendar-month__body__day__events-container");let r=o.data("offsetmonth");(void 0===r||r.length<=0)&&(r=this.$mainContainer.find(".sugar-calendar-block__view-heading").text());var a=sugar_calendar_obj.strings.events_on,i=o.find(".sugar-calendar-block__calendar-month__body__day__number").text().trim();let l=a.replace("[Month Date]",r);i&&(l=l+" "+i),e.text(l),n.html(t.clone()),this.$mobileListContainer.show()},n.prototype.displayEvents=function(){if("week"===this.getDisplay())this.displayEventsOnWeekDisplay();else if("day"===this.getDisplay())this.displayEventsOnDayDisplay();else{let t=this.getTimeOfDay(),o=this.getDaysOfWeek(),r=[],i=this.$mainContainer.find(".sugar-calendar-block__calendar-month");i.find(".sugar-calendar-block__calendar-month__body__day__events-container").each((a,e)=>{let n=s(e);n.find(".sugar-calendar-block__event-cell").each((a,e)=>{e=s(e);(0===o.length||0<s(o).filter([n.data("weekday").toString()]).length)&&(0===t.length||0<s(t).filter(e.data("daydiv")).length)?(e.removeClass("sugar-calendar-block__calendar-month__cell-hide"),r.push(e.data("eventid"))):(e.addClass("sugar-calendar-block__calendar-month__cell-hide"),i.find(".sugar-calendar-block__calendar-month__spacer-eventid-"+e.data("eventid")).addClass("sugar-calendar-block__calendar-month__cell-hide"))})}),r.forEach(a=>{i.find(".sugar-calendar-block__calendar-month__body__day__events-container__event-id-"+a).removeClass("sugar-calendar-block__calendar-month__cell-hide"),i.find(".sugar-calendar-block__calendar-month__spacer-eventid-"+a).removeClass("sugar-calendar-block__calendar-month__cell-hide")})}},n.prototype.filterDisplayWeekView=function(a,n,t,o,r=!1){let i=[];return this.$mainContainer.find(a).each((a,e)=>{e=s(e);0===t.length||0<s(t).filter([e.data("weekday").toString()]).length?e.find(n).each((a,e)=>{e=s(e);0===o.length||0<s(o).filter(e.data("daydiv")).length?r?i.uniquePush(e.data("eventid")):e.removeClass("sugar-calendar-block__calendar-month__cell-hide"):e.addClass("sugar-calendar-block__calendar-month__cell-hide")}):e.find(n).addClass("sugar-calendar-block__calendar-month__cell-hide")}),i},n.prototype.displayEventsOnWeekDisplay=function(){var a=this.getDaysOfWeek(),e=this.getTimeOfDay();this.filterDisplayWeekView(".sugar-calendar-block__calendar-week__event-slot--all-day",".sugar-calendar-block__calendar-week__event-cell--all-day",a,e,!0).forEach(a=>{this.$mainContainer.find(".sugar-calendar-block__calendar-week__event-cell--id-"+a).removeClass("sugar-calendar-block__calendar-month__cell-hide")}),this.filterDisplayWeekView(".sugar-calendar-block__calendar-week__time-grid__day-col",".sugar-calendar-block__calendar-week__event-cell",a,e)},n.prototype.displayEventsOnDayDisplay=function(){let n=this.getTimeOfDay();0===n.length?this.$mainContainer.find(".sugar-calendar-block__event-cell").removeClass("sugar-calendar-block__calendar-month__cell-hide"):this.$mainContainer.find(".sugar-calendar-block__event-cell").each((a,e)=>{e=s(e);0<s(n).filter(e.data("daydiv")).length?e.removeClass("sugar-calendar-block__calendar-month__cell-hide"):e.addClass("sugar-calendar-block__calendar-month__cell-hide")})},{init:function(){s(r).on("load",function(){o.load()})},load:function(){void 0!==r.FloatingUIDOM&&(h=r.FloatingUIDOM,o.initCalendars(),s("body").on("click",o.closePopoversOnBodyClick))},initCalendars:function(){s(".sugar-calendar-block").each(function(){new n(s(this))})},closePopoversOnBodyClick:function(a){var e=s(this);!e.hasClass("sugar-calendar-block__popovers__active")||(a=s(a.target)).hasClass("sugar-calendar-block__controls__left__date")||a.hasClass("sugar-calendar-block__controls__right__settings__btn")||a.hasClass("sugar-calendar-block__controls__right__view__btn")||a.hasClass("sugar-calendar-block__event-cell")||a.hasClass("sugar-calendar-block__popover")||0<a.parents(".sugar-calendar-block__controls__left__date").length||0<a.parents(".sugar-calendar-block__controls__right__settings__btn").length||0<a.parents(".sugar-calendar-block__controls__right__view__btn").length||0<a.parents(".sugar-calendar-block__event-cell").length||0<a.parents(".sugar-calendar-block__popover").length||d(e)}});return o}((document,window),jQuery);sugar_calendar.init();