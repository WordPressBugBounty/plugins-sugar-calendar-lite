"use strict";const SCAdminImporters=window.SCAdminImporters||function(n){const m={runtime_vars:{importer_slug:"",number_of_retries:0,total_number_to_import:{events:null,venues:null,speakers:null,tickets:null,orders:null,attendees:null,categories:null,tags:null},number_of_success_import:{events:0,venues:0,speakers:0,tickets:0,orders:0,attendees:0,categories:0,tags:0},last_migrated_context:null,ics_url:null,assets_url:null,doms:{$import_file_field:null,$import_file_info_span:null,$import_ics_url_field:null,$import_sc_btn:null,$import_ics_btn:null,$importer_logs:null,$importer_logs_status:null,$import_ics_form:null,$import_ics_summary:null},strings:{}},init(){n(m.ready)},ready(){m.cacheDom(),m.bindEvents(),m.setDefaults()},cacheDom(){m.runtime_vars.doms.$import_file_info_span=n("#sc-admin-tools-form-import-file-info"),m.runtime_vars.doms.$import_file_field=n("#sc-admin-tools-form-import"),m.runtime_vars.doms.$import_sc_btn=n("#sc-admin-tools-sc-import-btn"),m.runtime_vars.doms.$importer_logs=n("#sc-admin-importer-tec-logs"),m.runtime_vars.doms.$importer_logs_status=n("#sc-admin-importer-tec-logs__status")},setDefaults:function(){jconfirm.defaults={typeAnimated:!1,draggable:!1,animateFromElement:!1,boxWidth:"400px",useBootstrap:!1}},bindEvents(){n("#sc-admin-tools-import-btn").on("click",function(t){t.preventDefault(),m.runtime_vars.assets_url=sc_admin_importers.assets_url,m.runtime_vars.strings=sc_admin_importers.strings;const r=n(this);t=r.data("warning");t&&"1"===t.toString()?n.confirm({backgroundDismiss:!1,escapeKey:!0,animationBounce:1,type:"orange",icon:m.getIcon("info-circle"),title:sc_admin_importers.strings.heads_up,content:sc_admin_importers.strings.recurring_events_warning,buttons:{confirm:{text:sc_admin_importers.strings.yes,btnClass:"btn-confirm",keys:["enter"],action:function(){m.performImport(r)}},cancel:{text:sc_admin_importers.strings.cancel,btnClass:"btn-cancel"}}}):m.performImport(r)}),n("#sc-admin-tools-sc-import-btn").on("click",function(t){var r=n(this);m.runtime_vars.doms.$import_file_field.val()?(r.find(".sc-admin-tools-sc-import-btn__text").addClass("sc-admin-tools__invisible"),r.append('<span class="sc-admin-tools-loading-spinner"></span>'),r.blur()):(t.preventDefault(),m.runtime_vars.strings=sc_admin_importers.strings,m.runtime_vars.assets_url=sc_admin_importers.assets_url,n.confirm({title:!1,content:m.runtime_vars.strings.please_select_file,titleClass:"sc-ics-importer-error-title",icon:m.getIcon("info-circle"),type:"red",buttons:{confirm:{text:m.runtime_vars.strings.ok,btnClass:"sugar-calendar-btn sugar-calendar-btn-lg sugar-calendar-btn-primary",keys:["enter"]}}}))}),m.runtime_vars.doms.$import_file_field.on("change",function(t){t.target.value&&(m.runtime_vars.doms.$import_file_info_span.text(t.target.value.split("\\").pop()),m.runtime_vars.doms.$import_sc_btn.removeClass("sc-admin-tools-disabled"))}),n("#sc-admin-tools-import-form-ics").on("submit",function(t){t.preventDefault(),m.runtime_vars.doms.$import_ics_form=n("form#sc-admin-tools-import-form-ics"),m.runtime_vars.doms.$import_ics_url_field=n(this).find("#sugar-calendar-setting-sc-admin-tools-ics-import-url"),m.runtime_vars.doms.$import_ics_btn=n(this).find("#sc-admin-tools-sc-import-ics-btn"),m.runtime_vars.doms.$import_ics_summary=n(".sc-admin-tools-import-summary-ics"),m.runtime_vars.strings=sc_admin_ics_importers.strings,m.runtime_vars.assets_url=sc_admin_ics_importers.assets_url,0<m.runtime_vars.doms.$import_ics_url_field.val().length&&(m.runtime_vars.ics_url=m.runtime_vars.doms.$import_ics_url_field.val(),m.runtime_vars.importer_slug="sugar-calendar-ics",m.toggleEnabledIcsButtonState(!1),m.runIcsImporter())})},toggleEnabledIcsButtonState(t){t?(m.runtime_vars.doms.$import_ics_btn.removeClass("sc-admin-tools__invisible"),m.runtime_vars.doms.$import_ics_btn.find(".sc-admin-tools-loading-spinner").remove(),m.runtime_vars.doms.$import_ics_btn.prop("disabled",!1)):(m.runtime_vars.doms.$import_ics_btn.addClass("sc-admin-tools__invisible"),m.runtime_vars.doms.$import_ics_btn.append('<span class="sc-admin-tools-loading-spinner"></span>'),m.runtime_vars.doms.$import_ics_btn.blur(),m.runtime_vars.doms.$import_ics_btn.prop("disabled",!0))},showIcsSummaryState(t){m.runtime_vars.doms.$import_ics_form.addClass("hidden"),m.runtime_vars.doms.$import_ics_summary.addClass("visible"),m.runtime_vars.doms.$import_ics_summary.find(".sc-admin-tools-import-summary__item-events-created").removeClass("hidden"),m.runtime_vars.doms.$import_ics_summary.find(".sc-admin-tools-import-summary__item-events-created .sc-admin-tools-import-summary-ics__item__value").text(t.created),m.runtime_vars.doms.$import_ics_summary.find(".sc-admin-tools-import-summary__item-events-updated").removeClass("hidden"),m.runtime_vars.doms.$import_ics_summary.find(".sc-admin-tools-import-summary__item-events-updated .sc-admin-tools-import-summary-ics__item__value").text(t.updated)},performImport(t){void 0!==t.data("importer")&&(m.runtime_vars.importer_slug=t.data("importer")),n("#sc-admin-importer-tec-status").text(sc_admin_importers.strings.migration_in_progress).show(),m.runImporter(),t.prop("disabled",!0),t.hide()},getIcon(t){return'"></i><img src="'+m.runtime_vars.assets_url+"images/icons/"+t+'.svg" style="width: 40px; height: 40px;" alt="Icon"><i class="'},runImporter(){n.post(sc_admin_importers.ajax_url,{nonce:sc_admin_importers.nonce,action:"sc_admin_importer",importer_slug:m.runtime_vars.importer_slug,total_number_to_import:m.runtime_vars.total_number_to_import},function(t){t.success?(m.runtime_vars.last_migrated_context||(m.runtime_vars.last_migrated_context=t.data.importer.process),m.runtime_vars.doms.$importer_logs_status.text(sc_admin_importers.strings[t.data.importer.status]),"complete"===t.data.importer.status?(n("#sc-admin-importer-tec-status").text(sc_admin_importers.strings.migration_completed),t.data.importer.error_html&&0<t.data.importer.error_html.length&&n("#sc-admin-importer-tec-logs").after(t.data.importer.error_html)):("hidden"!==t.data.importer.process&&(m.showLogs(t.data.importer.process,t.data.importer.progress,t.data.importer.total_number_to_import,t.data.importer.process_status),t.data.importer.attendees_count)&&m.showLogs("attendees",t.data.importer.attendees_count,t.data.importer.attendees_total_count,t.data.importer.process_status),m.runImporter())):m.retryAttempt()}).fail(function(t){m.retryAttempt()})},runIcsImporter(t=!1){n.post(sc_admin_ics_importers.ajax_url,{nonce:sc_admin_ics_importers.nonce,action:"sc_admin_importer",importer_slug:m.runtime_vars.importer_slug,total_number_to_import:m.runtime_vars.total_number_to_import,ics_url:m.runtime_vars.ics_url,clear_cache:t},function(t){if(t.success){var r=t.data.importer.status,s=t.data.importer.total_number_to_import,e=t.data.importer.progress,i=t.data.importer.message;switch(r){case"completed":m.showIcsSummaryState(e);break;case"error":n.alert({title:!1,content:i,titleClass:"sc-ics-importer-error-title",icon:m.getIcon("info-circle"),type:"red",boxWidth:"400px",buttons:{confirm:{text:sc_admin_ics_importers.strings.ok,btnClass:"sugar-calendar-btn sugar-calendar-btn-lg sugar-calendar-btn-primary",keys:["enter"]}}});break;case"in_progress":return m.runtime_vars.total_number_to_import.events=s,void m.runIcsImporter()}m.toggleEnabledIcsButtonState(!0)}else m.retryAttempt(function(){m.runIcsImporter(!0)},function(){m.toggleEnabledIcsButtonState(!0)})}).fail(function(t){m.retryAttempt(function(){m.runIcsImporter(!0)},function(){m.toggleEnabledIcsButtonState(!0)})})},showLogs(r,s,e,t){m.runtime_vars.number_of_success_import[r]+=s;var s="sc-admin-importer-tec-logs__progress-"+r,i="sc-admin-importer-tec-logs__process-"+r,o=m.runtime_vars.number_of_success_import[r];if(0<n("#"+i).length)n("#"+s).text(o);else{m.runtime_vars.total_number_to_import[r]||(m.runtime_vars.total_number_to_import[r]=e);let t="";void 0!==e&&(t="/"+m.runtime_vars.total_number_to_import[r]),m.runtime_vars.doms.$importer_logs.append('<div id="'+i+'" class="sc-admin-tools-migrate-context"><div class="sc-admin-tools-migrate-context__status"><div class="sc-admin-tools-migrate-context__status__in-progress"></div></div><div class="sc-admin-tools-migrate-context__info">'+sc_admin_importers.strings["migrated_"+r]+' <span id="'+s+'">'+o+"</span>"+t+"</div></div>")}(o>=m.runtime_vars.total_number_to_import[r]||"complete"===t)&&n("#sc-admin-importer-tec-logs__process-"+r).find(".sc-admin-tools-migrate-context__status").html('<div class="sc-admin-tools-migrate-context__status__complete"></div>')},retryAttempt(t,r){5<=m.runtime_vars.number_of_retries?(alert(m.runtime_vars.strings.migration_failed),r&&r()):(++m.runtime_vars.number_of_retries,t?t():m.runImporter())}};return m}((document,window,jQuery));SCAdminImporters.init();